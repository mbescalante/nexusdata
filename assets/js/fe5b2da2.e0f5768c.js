"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5422],{2035:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>t,contentTitle:()=>o,default:()=>d,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"graphql-api/subscriptions","title":"Suscripciones","description":"Las suscripciones GraphQL te permiten recibir actualizaciones en tiempo real cuando ocurren cambios en los datos. A diferencia de las consultas y mutaciones que siguen un modelo de solicitud-respuesta, las suscripciones establecen una conexi\xf3n persistente que env\xeda datos al cliente cuando ocurren eventos espec\xedficos.","source":"@site/docs/graphql-api/subscriptions.md","sourceDirName":"graphql-api","slug":"/graphql-api/subscriptions","permalink":"/docs/graphql-api/subscriptions","draft":false,"unlisted":false,"editUrl":"https://github.com/nexusdata/nexusdata-docs/edit/main/docs/graphql-api/subscriptions.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Mutaciones","permalink":"/docs/graphql-api/mutations"},"next":{"title":"Gu\xeda Pr\xe1ctica de Servicios HTTP","permalink":"/docs/servicios-http/"}}');var i=r(4848),a=r(8453);const c={sidebar_position:3},o="Suscripciones",t={},l=[{value:"Estructura B\xe1sica de Suscripciones",id:"estructura-b\xe1sica-de-suscripciones",level:2},{value:"Suscripciones Generadas Autom\xe1ticamente",id:"suscripciones-generadas-autom\xe1ticamente",level:2},{value:"Suscripci\xf3n a Creaciones (onCreate)",id:"suscripci\xf3n-a-creaciones-oncreate",level:3},{value:"Suscripci\xf3n a Actualizaciones (onUpdate)",id:"suscripci\xf3n-a-actualizaciones-onupdate",level:3},{value:"Suscripci\xf3n a Eliminaciones (onDelete)",id:"suscripci\xf3n-a-eliminaciones-ondelete",level:3},{value:"Filtros en Suscripciones",id:"filtros-en-suscripciones",level:2},{value:"Suscripciones a Campos Espec\xedficos",id:"suscripciones-a-campos-espec\xedficos",level:2},{value:"Implementaci\xf3n de Suscripciones",id:"implementaci\xf3n-de-suscripciones",level:2},{value:"Suscripciones Personalizadas",id:"suscripciones-personalizadas",level:2},{value:"Suscripciones con Autenticaci\xf3n",id:"suscripciones-con-autenticaci\xf3n",level:2},{value:"Uso en el Cliente",id:"uso-en-el-cliente",level:2},{value:"Apollo Client",id:"apollo-client",level:3},{value:"Uso de Suscripciones en React",id:"uso-de-suscripciones-en-react",level:3},{value:"Escalabilidad de Suscripciones",id:"escalabilidad-de-suscripciones",level:2},{value:"Redis PubSub",id:"redis-pubsub",level:3},{value:"Kafka PubSub",id:"kafka-pubsub",level:3},{value:"Limitaci\xf3n de Recursos",id:"limitaci\xf3n-de-recursos",level:2},{value:"Depuraci\xf3n de Suscripciones",id:"depuraci\xf3n-de-suscripciones",level:2},{value:"Mejores Pr\xe1cticas",id:"mejores-pr\xe1cticas",level:2},{value:"Casos de Uso Comunes",id:"casos-de-uso-comunes",level:2},{value:"Pr\xf3ximos Pasos",id:"pr\xf3ximos-pasos",level:2}];function u(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"suscripciones",children:"Suscripciones"})}),"\n",(0,i.jsx)(n.p,{children:"Las suscripciones GraphQL te permiten recibir actualizaciones en tiempo real cuando ocurren cambios en los datos. A diferencia de las consultas y mutaciones que siguen un modelo de solicitud-respuesta, las suscripciones establecen una conexi\xf3n persistente que env\xeda datos al cliente cuando ocurren eventos espec\xedficos."}),"\n",(0,i.jsx)(n.h2,{id:"estructura-b\xe1sica-de-suscripciones",children:"Estructura B\xe1sica de Suscripciones"}),"\n",(0,i.jsx)(n.p,{children:"Una suscripci\xf3n GraphQL b\xe1sica tiene la siguiente estructura:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:"subscription {\r\n  eventName(filter: { field: value }) {\r\n    field1\r\n    field2\r\n    relation {\r\n      field1\r\n      field2\r\n    }\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"suscripciones-generadas-autom\xe1ticamente",children:"Suscripciones Generadas Autom\xe1ticamente"}),"\n",(0,i.jsx)(n.p,{children:"NexusData genera autom\xe1ticamente las siguientes suscripciones para cada modelo:"}),"\n",(0,i.jsx)(n.h3,{id:"suscripci\xf3n-a-creaciones-oncreate",children:"Suscripci\xf3n a Creaciones (onCreate)"}),"\n",(0,i.jsx)(n.p,{children:"Recibe notificaciones cuando se crea un nuevo registro:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:"subscription {\r\n  onCreateUser {\r\n    id\r\n    email\r\n    firstName\r\n    lastName\r\n    role\r\n    createdAt\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"suscripci\xf3n-a-actualizaciones-onupdate",children:"Suscripci\xf3n a Actualizaciones (onUpdate)"}),"\n",(0,i.jsx)(n.p,{children:"Recibe notificaciones cuando se actualiza un registro existente:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:'subscription {\r\n  onUpdateProduct(where: { category: "Electronics" }) {\r\n    id\r\n    name\r\n    price\r\n    stock\r\n    updatedAt\r\n    updatedFields\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"suscripci\xf3n-a-eliminaciones-ondelete",children:"Suscripci\xf3n a Eliminaciones (onDelete)"}),"\n",(0,i.jsx)(n.p,{children:"Recibe notificaciones cuando se elimina un registro:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:"subscription {\r\n  onDeleteOrder {\r\n    id\r\n    status\r\n    deletedAt\r\n  }\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"filtros-en-suscripciones",children:"Filtros en Suscripciones"}),"\n",(0,i.jsx)(n.p,{children:"Puedes filtrar las notificaciones que recibes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:'subscription {\r\n  onUpdateUser(\r\n    where: {\r\n      role: { in: [ADMIN, EDITOR] },\r\n      OR: [\r\n        { isActive: { equals: false } },\r\n        { lastLogin: { lt: "2023-01-01T00:00:00Z" } }\r\n      ]\r\n    }\r\n  ) {\r\n    id\r\n    email\r\n    role\r\n    isActive\r\n    lastLogin\r\n    updatedFields\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"suscripciones-a-campos-espec\xedficos",children:"Suscripciones a Campos Espec\xedficos"}),"\n",(0,i.jsx)(n.p,{children:"Puedes suscribirte a cambios en campos espec\xedficos:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:'subscription {\r\n  onUpdateProduct(\r\n    where: { \r\n      id: "prod123",\r\n      updatedFields: { contains: "price" }\r\n    }\r\n  ) {\r\n    id\r\n    name\r\n    price\r\n    previousValues {\r\n      price\r\n    }\r\n    updatedFields\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"implementaci\xf3n-de-suscripciones",children:"Implementaci\xf3n de Suscripciones"}),"\n",(0,i.jsx)(n.p,{children:"NexusData utiliza WebSockets para implementar suscripciones GraphQL. La configuraci\xf3n b\xe1sica es autom\xe1tica, pero puedes personalizarla:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// nexusdata.config.js\r\nmodule.exports = {\r\n  // ... otras configuraciones\r\n  graphql: {\r\n    subscriptions: {\r\n      enabled: true,\r\n      path: '/graphql/subscriptions',\r\n      keepAlive: 30000, // 30 segundos\r\n      onConnect: async (connectionParams, webSocket, context) => {\r\n        // L\xf3gica de autenticaci\xf3n para suscripciones\r\n        if (connectionParams.authToken) {\r\n          const user = await verifyToken(connectionParams.authToken);\r\n          return { user };\r\n        }\r\n        throw new Error('Autenticaci\xf3n requerida para suscripciones');\r\n      },\r\n      onDisconnect: async (webSocket, context) => {\r\n        // Limpiar recursos cuando el cliente se desconecta\r\n        console.log('Cliente desconectado');\r\n      }\r\n    }\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"suscripciones-personalizadas",children:"Suscripciones Personalizadas"}),"\n",(0,i.jsx)(n.p,{children:"Adem\xe1s de las suscripciones generadas autom\xe1ticamente, puedes definir suscripciones personalizadas:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// src/resolvers/notifications/userActivity.js\r\nmodule.exports = {\r\n  name: 'userActivity',\r\n  type: 'UserActivityEvent',\r\n  args: {\r\n    userId: 'ID',\r\n    activityType: '[ActivityType!]'\r\n  },\r\n  subscribe: async (parent, args, context) => {\r\n    const { userId, activityType } = args;\r\n    const { pubsub } = context;\r\n    \r\n    // Crear un filtro basado en los argumentos\r\n    const filter = (payload) => {\r\n      if (userId && payload.userId !== userId) return false;\r\n      if (activityType && !activityType.includes(payload.type)) return false;\r\n      return true;\r\n    };\r\n    \r\n    // Suscribirse al canal de eventos con filtro\r\n    return pubsub.asyncIterator('USER_ACTIVITY', filter);\r\n  },\r\n  resolve: (payload) => {\r\n    return payload;\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.p,{children:"Publicaci\xf3n de eventos:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// En cualquier parte de tu c\xf3digo\r\ncontext.pubsub.publish('USER_ACTIVITY', {\r\n  userId: user.id,\r\n  type: 'LOGIN',\r\n  timestamp: new Date(),\r\n  metadata: {\r\n    ip: request.ip,\r\n    userAgent: request.headers['user-agent']\r\n  }\r\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"Uso:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-graphql",children:'subscription {\r\n  userActivity(userId: "user123", activityType: [LOGIN, LOGOUT, PROFILE_UPDATE]) {\r\n    userId\r\n    type\r\n    timestamp\r\n    metadata {\r\n      ip\r\n      userAgent\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"suscripciones-con-autenticaci\xf3n",children:"Suscripciones con Autenticaci\xf3n"}),"\n",(0,i.jsx)(n.p,{children:"Puedes proteger tus suscripciones con autenticaci\xf3n:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// src/resolvers/chat/messageReceived.js\r\nmodule.exports = {\r\n  name: 'messageReceived',\r\n  type: 'ChatMessage',\r\n  args: {\r\n    channelId: 'ID!'\r\n  },\r\n  authenticate: true, // Requiere autenticaci\xf3n\r\n  authorize: async (user, args, context) => {\r\n    // Verificar si el usuario tiene acceso al canal\r\n    const { channelId } = args;\r\n    const channel = await context.models.Channel.findUnique({\r\n      where: { id: channelId },\r\n      include: { members: true }\r\n    });\r\n    \r\n    return channel && channel.members.some(member => member.userId === user.id);\r\n  },\r\n  subscribe: async (parent, args, context) => {\r\n    const { channelId } = args;\r\n    const { pubsub } = context;\r\n    \r\n    // Suscribirse al canal espec\xedfico\r\n    return pubsub.asyncIterator(`CHAT:${channelId}`);\r\n  },\r\n  resolve: (payload) => {\r\n    return payload;\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"uso-en-el-cliente",children:"Uso en el Cliente"}),"\n",(0,i.jsx)(n.h3,{id:"apollo-client",children:"Apollo Client"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"import { ApolloClient, InMemoryCache, split, HttpLink } from '@apollo/client';\r\nimport { getMainDefinition } from '@apollo/client/utilities';\r\nimport { WebSocketLink } from '@apollo/client/link/ws';\r\n\r\n// Crear enlace HTTP para consultas y mutaciones\r\nconst httpLink = new HttpLink({\r\n  uri: 'https://api.ejemplo.com/graphql',\r\n  headers: {\r\n    authorization: `Bearer ${localStorage.getItem('token')}`\r\n  }\r\n});\r\n\r\n// Crear enlace WebSocket para suscripciones\r\nconst wsLink = new WebSocketLink({\r\n  uri: 'wss://api.ejemplo.com/graphql/subscriptions',\r\n  options: {\r\n    reconnect: true,\r\n    connectionParams: {\r\n      authToken: localStorage.getItem('token')\r\n    }\r\n  }\r\n});\r\n\r\n// Usar el enlace adecuado seg\xfan la operaci\xf3n\r\nconst splitLink = split(\r\n  ({ query }) => {\r\n    const definition = getMainDefinition(query);\r\n    return (\r\n      definition.kind === 'OperationDefinition' &&\r\n      definition.operation === 'subscription'\r\n    );\r\n  },\r\n  wsLink,\r\n  httpLink\r\n);\r\n\r\n// Crear cliente Apollo\r\nconst client = new ApolloClient({\r\n  link: splitLink,\r\n  cache: new InMemoryCache()\r\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"uso-de-suscripciones-en-react",children:"Uso de Suscripciones en React"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jsx",children:"import { useSubscription, gql } from '@apollo/client';\r\n\r\nconst NEW_MESSAGE_SUBSCRIPTION = gql`\r\n  subscription OnNewMessage($channelId: ID!) {\r\n    messageReceived(channelId: $channelId) {\r\n      id\r\n      text\r\n      createdAt\r\n      sender {\r\n        id\r\n        name\r\n        avatar\r\n      }\r\n    }\r\n  }\r\n`;\r\n\r\nfunction ChatRoom({ channelId }) {\r\n  const { data, loading, error } = useSubscription(\r\n    NEW_MESSAGE_SUBSCRIPTION,\r\n    { variables: { channelId } }\r\n  );\r\n  \r\n  // Cuando llega un nuevo mensaje\r\n  useEffect(() => {\r\n    if (data && data.messageReceived) {\r\n      // Actualizar la UI con el nuevo mensaje\r\n      addMessageToChat(data.messageReceived);\r\n    }\r\n  }, [data]);\r\n  \r\n  // Resto del componente\r\n  // ...\r\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"escalabilidad-de-suscripciones",children:"Escalabilidad de Suscripciones"}),"\n",(0,i.jsx)(n.p,{children:"Para aplicaciones a gran escala, NexusData soporta m\xfaltiples estrategias de publicaci\xf3n/suscripci\xf3n:"}),"\n",(0,i.jsx)(n.h3,{id:"redis-pubsub",children:"Redis PubSub"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// nexusdata.config.js\r\nmodule.exports = {\r\n  // ... otras configuraciones\r\n  graphql: {\r\n    subscriptions: {\r\n      enabled: true,\r\n      pubsub: {\r\n        type: 'redis',\r\n        options: {\r\n          host: process.env.REDIS_HOST,\r\n          port: process.env.REDIS_PORT,\r\n          password: process.env.REDIS_PASSWORD,\r\n          retryStrategy: (times) => Math.min(times * 50, 2000)\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h3,{id:"kafka-pubsub",children:"Kafka PubSub"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// nexusdata.config.js\r\nmodule.exports = {\r\n  // ... otras configuraciones\r\n  graphql: {\r\n    subscriptions: {\r\n      enabled: true,\r\n      pubsub: {\r\n        type: 'kafka',\r\n        options: {\r\n          clientId: 'nexusdata-subscriptions',\r\n          brokers: [process.env.KAFKA_BROKER],\r\n          ssl: true,\r\n          sasl: {\r\n            mechanism: 'plain',\r\n            username: process.env.KAFKA_USERNAME,\r\n            password: process.env.KAFKA_PASSWORD\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"limitaci\xf3n-de-recursos",children:"Limitaci\xf3n de Recursos"}),"\n",(0,i.jsx)(n.p,{children:"Para evitar problemas de rendimiento, es importante configurar l\xedmites adecuados:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// nexusdata.config.js\r\nmodule.exports = {\r\n  // ... otras configuraciones\r\n  graphql: {\r\n    subscriptions: {\r\n      enabled: true,\r\n      // L\xedmites para evitar sobrecarga\r\n      maxSubscriptionsPerClient: 10,\r\n      maxSubscriptionLifetime: 3600000, // 1 hora en milisegundos\r\n      throttle: {\r\n        rate: 5, // eventos por segundo\r\n        burst: 10 // m\xe1ximo de eventos en r\xe1faga\r\n      }\r\n    }\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"depuraci\xf3n-de-suscripciones",children:"Depuraci\xf3n de Suscripciones"}),"\n",(0,i.jsx)(n.p,{children:"NexusData proporciona herramientas para depurar suscripciones:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// nexusdata.config.js\r\nmodule.exports = {\r\n  // ... otras configuraciones\r\n  graphql: {\r\n    subscriptions: {\r\n      enabled: true,\r\n      debug: process.env.NODE_ENV === 'development',\r\n      onOperation: (message, params, webSocket) => {\r\n        console.log(`Operaci\xf3n de suscripci\xf3n: ${message.payload.operationName}`);\r\n        return params;\r\n      }\r\n    }\r\n  }\r\n};\n"})}),"\n",(0,i.jsx)(n.h2,{id:"mejores-pr\xe1cticas",children:"Mejores Pr\xe1cticas"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Limitar el alcance : Define suscripciones espec\xedficas en lugar de notificar sobre todos los cambios."}),"\n",(0,i.jsx)(n.li,{children:"Filtrar en el servidor : Aplica filtros en el servidor para reducir el tr\xe1fico de red."}),"\n",(0,i.jsx)(n.li,{children:"Autenticaci\xf3n : Siempre protege tus suscripciones con autenticaci\xf3n adecuada."}),"\n",(0,i.jsx)(n.li,{children:"Manejo de desconexiones : Implementa l\xf3gica para manejar reconexiones y recuperaci\xf3n de estado."}),"\n",(0,i.jsx)(n.li,{children:"Monitoreo : Supervisa el n\xfamero de conexiones activas y el uso de recursos."}),"\n",(0,i.jsx)(n.li,{children:"Pruebas de carga : Verifica c\xf3mo se comportan tus suscripciones bajo carga."}),"\n",(0,i.jsx)(n.li,{children:"Timeouts : Configura timeouts adecuados para liberar recursos cuando los clientes se desconectan."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"casos-de-uso-comunes",children:"Casos de Uso Comunes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Actualizaciones de chat en tiempo real : Notificar a los usuarios cuando se reciben nuevos mensajes."}),"\n",(0,i.jsx)(n.li,{children:"Notificaciones de sistema : Alertar a los usuarios sobre eventos importantes."}),"\n",(0,i.jsx)(n.li,{children:"Tableros en tiempo real : Actualizar dashboards con m\xe9tricas en vivo."}),"\n",(0,i.jsx)(n.li,{children:"Colaboraci\xf3n en tiempo real : Sincronizar cambios entre m\xfaltiples usuarios trabajando en el mismo documento."}),"\n",(0,i.jsx)(n.li,{children:"Monitoreo de estado : Seguir el estado de procesos de larga duraci\xf3n."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"pr\xf3ximos-pasos",children:"Pr\xf3ximos Pasos"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Aprende sobre consultas GraphQL para recuperar datos"}),"\n",(0,i.jsx)(n.li,{children:"Explora mutaciones GraphQL para modificar datos"}),"\n",(0,i.jsx)(n.li,{children:"Implementa l\xf3gica de negocio personalizada en tus resolvers"}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>o});var s=r(6540);const i={},a=s.createContext(i);function c(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);